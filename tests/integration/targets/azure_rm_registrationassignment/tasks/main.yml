- name: set facts
  set_fact:
    subscription_id: "{{ azure_subscription_id }}"
    managed_by_tenant_id: "{{ azure_managed_by_tenant_id }}"
    principal_id: "{{ azure_principal_id }}"
    role_definition_id: "{{ azure_role_definition_id }}"
    registration_assignment_id: d7f791f8-7b3c-4120-a550-6882a8668efd
    registration_definition_id: 29572dbb-04f0-4c0c-885a-e1eaa35032c1

  run_once: yes

- name: Create a RegistrationDefinition
  azure_rm_registrationdefinition:
    registration_definition_id: "{{ registration_definition_id }}"
    scope: subscriptions/{{ subscription_id }}
    properties:
      description: first_test
      authorizations:
        - principal_id: "{{ principal_id }}"
          role_definition_id: "{{ role_definition_id }}"
      managed_by_tenant_id: "{{ managed_by_tenant_id }}"
      name: test_def
  register: output1

- name: Create a RegistrationAssignment ---check mode
  azure_rm_registrationassignment:
    registration_assignment_id: "{{ registration_assignment_id }}"
    scope: subscriptions/{{ subscription_id }}
    properties:
      registration_definition_id: "{{ output1.state.id }}"
  register: output
  check_mode: yes

- name: Create a RegistrationAssignment 
  azure_rm_registrationassignment:
    registration_assignment_id: "{{ registration_assignment_id }}"
    scope: subscriptions/{{ subscription_id }}
    properties:
      registration_definition_id: "{{ output1.state.id }}"

- name: Create a RegistrationAssignment -- idempotent
  azure_rm_registrationassignment:
    scope: subscriptions/{{ subscription_id }}
    registration_assignment_id:  "{{ registration_assignment_id }}"
    properties:
      registration_definition_id: "{{ output1.state.id }}"
  register: output


- name: Get a RegistrationAssignment
  azure_rm_registrationassignment_info:
    scope: subscriptions/{{ subscription_id }}
    registration_assignment_id:  "{{ registration_assignment_id }}"
    expand_registration_definition: False
  register: output


- name: Get all RegistrationAssignment
  azure_rm_registrationassignment_info:
    scope: subscriptions/{{ subscription_id }}
    expand_registration_definition: False
  register: output


- name: Delete the RegistrationAssignment
  azure_rm_registrationassignment:
    scope: subscriptions/{{ subscription_id }}
    registration_assignment_id:  "{{ registration_assignment_id }}"
    state: absent
