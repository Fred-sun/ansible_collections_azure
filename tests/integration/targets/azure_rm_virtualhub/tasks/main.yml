- set_fact:
    name: "{{ resource_group | hash('md5') | truncate(8, True, '') }}"

- name: Create a VirtualHub (check mode)
  azure_rm_virtualhub:
    resource_group: "{{ resource_group }}"
    name: "{{ name }}"
    address_prefix: 10.2.0.0/24
    sku: Standard
    location: eastus
    enable_virtual_router_route_propogation: false
    virtual_wan:
      id: "{{ id }}"
  check_mode: yes

- name: Create a VirtualHub
  azure_rm_virtualhub:
    resource_group: "{{ resource_group }}"
    name: "{{ name }}"
    address_prefix: 10.2.0.0/24
    sku: Standard
    location: eastus
    enable_virtual_router_route_propogation: false
    virtual_wan:
      id: "{{ id }}"
  register: output

- name: Assert the virtual hub is well created
  assert:
    that:
      - output.changed
      - output.state.provisioning_state == 'Succeeded'
   
- name: Create a VirtualHub (idempotent)
  azure_rm_virtualhub:
    resource_group: "{{ resource_group }}"
    name: "{{ name }}"
    address_prefix: 10.2.0.0/24
    sku: Standard
    location: eastus
    enable_virtual_router_route_propogation: false
    virtual_wan:
      id: "{{ id }}"
  register: output

- name: Assert idempotent
  assert:
    that:
      - output.changed

- name: Upgrade the VirtualHub 
  azure_rm_virtualhub:
    resource_group: "{{ resource_group }}"
    name: "{{ name }}"
    address_prefix: 10.2.0.0/24
    sku: Standard
    location: eastus
    enable_virtual_router_route_propogation: true
    virtual_wan:
      id: "{{ id }}"
  register: output

- name: Assert the AKS instance is upgraded
  assert:
    that:
      - output.changed

- name: VirtualHubGet
  azure_rm_virtualhub_info:
    resource_group: "{{ resource_group }}"
    name: "{{ name }}"
  register: output

- name: Assert fact returns
  assert:
    that:
      - output.virtual_hubs[0].address_prefix == "10.2.0.0/24"
      - output.virtual_hubs[0].provisioning_state == "Succeeded" 
      - output.virtual_hubs[0].sku == "Standard"

- name: Delete 
  azure_rm_virtualhub:
    resource_group: "{{ resource_group }}"
    name: "{{ name }}"
    location: eastus
    state: absent
  register: output

- name: Assert the AKS instance is upgraded
  assert:
    that:
      - output.changed
